---
title: "CHIC402/CHIC602 Coursework 2 - Variant Analysis"
author: 36112985
output: 
  pdf_document:
    number_sections: true
---


<!--- global Settings --->
```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

<!--- libraries --->
```{r include = FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
library(lubridate)
library(latex2exp)
```

<!--- External Functions
The set of [custom] external functions used by this document.
--->
```{r include = FALSE}
sys.source(file = 'R/functions/VariantProgressionModel.R', envir = knitr::knit_global())
sys.source(file = 'R/functions/VariantsData.R', envir = knitr::knit_global())
sys.source(file = 'R/functions/VariantsProportions.R', envir = knitr::knit_global())
sys.source(file = 'R/functions/GraphsDelta.R', envir = knitr::knit_global())
sys.source(file = 'R/functions/GraphsPredominant.R', envir = knitr::knit_global())
sys.source(file = 'R/functions/GraphsStacks.R', envir = knitr::knit_global())
sys.source(file = 'R/functions/GraphsVUI21OCT01.R', envir = knitr::knit_global())
```

<!--- the data --->
```{r include = FALSE}
# Reading-in the variants data
variants <- VariantsData()

# The time span of the variants' data set
starting <- min(variants$week)
ending <- max(variants$week)
```


This project focuses on the analysis of the United Kingdom's genetically-typed SARS-CoV-2 infections data.  The data set summarises the weekly infections fractions of $17$ SARS-CoV-2 variants, starting *`r starting`*, and ending *`r ending`*; additionally, there's the field \textcolor[rgb]{0.54, 0.25, 0.27}{\emph{Other}}, each value of this field represents a pooled fraction w.r.t. (with respect to) an unknown number of unnamed variants.

Each week has 2 fractions records: one for cases associated with known travel links, the other without.  Each week's sum of the $18$ infections fractions - due to the $17$ named SARS-CoV-2 variants & \textcolor[rgb]{0.54, 0.25, 0.27}{\emph{Other}} - is **1** per travel ...

\vspace{20pt}

# The Data

In this document the data frame variable \textcolor[rgb]{0.5, 0.5, 0.0}{\emph{variants}} stores the variants' data set.  It consists of

\vspace{10pt}

\small

```{r comment = '         '}
# The description of the variants data set
str(variants, vec.len = 3)
```

\normalsize

\vspace{20pt}

**Long Format**

Some parts of this document use the long form of data frame *variants*.  The variable *melted* stores the long form of data frame variable *variants*.

\small
```{r  comment = '         ', echo = TRUE}
  # The long form of data frame 'variants'
  melted <- variants %>%
          tidyr::gather(key = 'variant', value = 'fraction', -c(week, travel))
```
\normalsize

Its structure is

\small
```{r comment = '         '}
  # The description of melted
  str(melted, vec.len = 3)
```
\normalsize



\vspace{20pt}

**Infections Proportions Statistics**

Different parts of this document use infections proportion statistics.  Infections proportion statistics, by variant, are calculated by function *VariantsProportions( )*, and summarised in named-list variable *proportions*.

\vspace{10pt}

\small
```{r echo = TRUE}
  # Infections proportion statistics
  proportions <- VariantsProportions(melted = melted)
```
\normalsize

\vspace{10pt}

The contents of *proportions* are discussed in detail at appropriate points in this document.  In brief, *proportions* consists of four data frames: *none*, *travel*, *leading*, *leadingseries*.

\vspace{10pt}

\small

```{r comment = '         ', echo = TRUE}
  # The contents of the named-list variable 'proportions'; each is a  data frame.
  names(proportions)
```

\normalsize

\vspace{10pt}

The data frame *none* summarises the total contribution of each variant w.r.t. that data's time span ($`r starting` \rightarrow `r ending`$); similarly for *travel*.  The data frame *leading* lists the 5 variants responsible for the most infections (w.r.t. travel & non-travel) during the data's time span; *leadingseries* stores the infections' data of these five.

\vspace{35pt}

# An Exploration of Non-travel Data

Each variant's weekly data consists of two records.  One represents the infections-fraction associated with known travel links (denoted *travel* in field $travel$), whilst the other represents the infections-fraction without known travel links (denoted *none* in field $travel$).  This section focuses on non-travel data, and the variable **local** stores the applicable data.  The truncated data description highlights the number of non-travel data records.

```{r}
# 3.0
# The non-travel data only
local <- variants %>%
        dplyr::filter(travel == 'none')
```

\vspace{10pt}

\footnotesize

```{r size = 'tiny', comment = '          '}
# A preview of variable 'local'
str(local, vec.len = 3, list.len = 5)
```

\normalsize

\vspace{20pt}

## The Progression of Delta

A variant of interest, amongst the variants that contribute to the non-travel infections quantities, is the **Delta** variant.  During the data's time span the largest proportion of non-travel infections was due to the Delta variant.

\vspace{10pt}

\footnotesize

```{r }
knitr::kable(x = head(proportions$none), caption = 'The variants responsible for the 5 largest non-travel infections proportion')
```

\normalsize

\vspace{10pt}

```{r include = FALSE}
maxima <- local[which.max(local$Delta), c('week', 'Delta')]
```

The graph of $fig. \: \ldots$ illustrates the weekly progression of Delta variant infections over time.  Each week's Delta fraction
is a fraction of the week's total non-travel infections due to all recorded variants; named & `Other`.  Delta's
fractions peak at `r round(first(x = maxima$Delta), digits = 3)` on `r first(x = maxima$week)`; hereafter, it seems that the Delta fraction values are continuously, but slowly, declining.

<!--- Weekly Delta fractions over time --->
```{r fig.align = 'center', out.height = '65%', dpi = 85, fig.cap = 'The Weekly Non-Travel Delta Variant Infections Fractions Over Time'}
# 3.1.a
GraphsDelta(local = local)
```

\vspace{20pt}

## Variant Peaks

```{r include = FALSE}
peaks <- local %>%
        select(!(travel)) %>%
        tidyr::gather(key = 'variant', value = 'p', -week) %>%
        group_by(variant) %>%
        slice(which.max(p)) %>%
        arrange(desc(p))
```

In general, each variant has a fraction peak date w.r.t. the

* data time span: *`r starting`* $\rightarrow$ $`r ending`$
* non-travel data

The peak date of each variant, in descending peak-date--fraction order, is^[Note: `Other` is not a variant, it represents a collection of variants, therefore excluded.]

\footnotesize

```{r}
# the variants and their peak dates
knitr::kable(x = peaks[, c('variant', 'week', 'p')],
             col.names = c('Variant', 'Peak Date', 'Peak Date Fraction'),
             format = 'simple',
             digits = 3,
             caption = 'The variants responsible for the largest peak date fractions; w.r.t. data time span & non-travel data')
```

\normalsize

\vspace{35pt}

# Variant Proportions by Known/Unknown Travel Links
<! --- 4 --->

During the whole data time span, the five variants responsible for the five largest variant-infection--proportions, w.r.t. known & unknown travel links, are

\footnotesize

```{r}
knitr::kable(x = proportions$leading, format = 'simple', col.names = c('Variant', 'Proportion'),
             caption = 'The variants responsible for the five largest variant-infection--proportions w.r.t. entire data time span')
```

\normalsize

\vspace{20pt}

## The Predominant Variants
<!--- 4.1 --->

The time series of each variant of $table \: \ldots$ is illustrated in $fig. \: \ldots$.  the second graph has a rescaled ordinate axis, which makes it easier to observe the progression of low-fractions curves.  A few observations:

* **In relation to infections with known travel links**, the Alpha variant dominated initially, but the Beta & Eta fractions are fairly substantive.  During May 2021 the Delta variant overtook the Alpha variant - from May 2021, until the end of the data's time span, the Delta variant had the largest infections-fraction each week.  By the end of the period (a) the Alpha variant barely contributes to each week's travel linked infections, and (b) the fractional contributions of VUI.21OCT.01 are increasing each week.

* **In relation to infections without known travel links**, again the Alpha variant dominated initially, and quite comprehensively; the Beta & Eta variants contribute small fractions.  However, from May 2021 onward the Delta variant had the largest infections-fraction each week.  In line with

```{r out.width = '55%', fig.show = 'hold', fig.align = 'center', fig.subcap = c('original', 'zoom')}
PredominantVariants(predominant = proportions$leadingseries)
PredominantVariantsZoom(predominant = proportions$leadingseries)
```


\vspace{20pt}

## Progression Patterns
<!--- 4.2 & 4.3 --->

```{r include = FALSE}
stacksdata <- melted %>%
        mutate(segment = mapply(function (element, reference) if (element %in% reference) {element} else {'Other'},
                                element =  variant, MoreArgs = list('reference' = proportions$leading$variant))) %>%
        group_by(week, travel, segment) %>%
        summarise(proportion = sum(fraction), .groups = 'keep')
```

The graph of ...

```{r out.width = '45%', fig.align = 'center'}
StacksTravelYes(stacksdata = stacksdata)
```


On the other hand ...

```{r out.width = '45%', fig.align = 'center'}
StacksTravelNo(stacksdata = stacksdata)
```


\vspace{35pt}

# The New Variant
<!--- 5 --->

This chapter focuses on non-travel VUI.21OCT.01 variant data; the variable **vui21oct01** stores this data.

```{r include = FALSE}
# VUI.21OCT.01 Data
vui21oct01 <- variants %>%
        filter(travel == 'none') %>%
        select(week, 'VUI.21OCT.01')
```


## Non-travel VUI.21OCT.01 Cases Over Time

```{r out.width = '45%', fig.align = 'center'}
ProgressionVUI21OCT01(vui21oct01 = vui21oct01)
```


## A Prediction Model



An exponential growth model, for predicting daily infection fractions, has been developed.  The model is

$$p = e^{(d\beta + \alpha)}$$

wherein

* $\alpha = -526.0385$
* $\beta = 0.0277$
* $d \rightarrow  \text{days since 1970-01-01}$

The function $VariantProgressionModel( )$ uses this model to predict daily infection fractions w.r.t. (a) a start date, and (b) a length of time.  The variable **estimates** stores the predictions w.r.t. an entire year, starting from the starting date of the non-travel VUI.21OCT.01 data.

```{r}
starting <- min(vui21oct01$week)
period <- lubridate::years(x = 1)
estimates <- VariantProgressionModel(starting = starting, period = period)

selections <- rbind(estimates[estimates$date == '2021-09-01', c('date', 'prediction')],
             estimates[estimates$date == '2022-01-01', c('date', 'prediction')])
```

The predictions for *1 September 2021* & *1 January 2022* can be extracted from **estimates** ($table \ldots$).  The 1 January 2022 prediction is implausible because $`r first(x = selections[selections$date == '2022-01-01', 'prediction'])`$ > 1; herein, a prediction should not exceed 1, and it can only be one if, and only if, no other variant exist.

```{r}
knitr::kable(x = selections, digits = 3, format = 'simple', caption = 'Predictions for 1 September 2021 & 1 January 2022')
```



## Prediction Curve

```{r out.width = '45%', fig.align = 'center'}
PredictionsVUI21OCT01(vui21oct01 = vui21oct01, estimates = estimates)
```
